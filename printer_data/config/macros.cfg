[gcode_macro FILAMENTO]
description: "Cargar o descargar filamento, eligiendo tipo"

gcode:
    # Verificar si MATERIAL y ACCION han sido proporcionados
    {% if not params.MATERIAL or not params.ACCION %}
        RESPOND PREFIX="ERROR" MSG="Faltan parámetros: MATERIAL y ACCION. Ejemplo: MATERIAL=PLA ACCION=CARGAR"
        CANCEL_PRINT
    {% endif %}

    # Definir las variables MATERIAL y ACCION
    {% set material = params.MATERIAL|upper %}
    {% set accion = params.ACCION|upper %}

    # Mostrar el tipo de material y la acción
    RESPOND PREFIX="INFO" MSG="Filamento: { material } Acción: { accion }"

    # --- Temperaturas por material ---
    {% set temps = {"PLA": 210, "PETG": 240, "ABS": 250} %}
    {% set temp = temps.get(material, 210) %}

    # Guardar la temperatura anterior
    {% set prev_temp = printer.extruder.target if printer.extruder.target > 0 else 0 %}

    # Calentar si es necesario
    {% if printer.extruder.temperature < (temp - 5) %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
        M109 S{temp}
    {% endif %}

    G91  ; Modo relativo

    # Comportamiento según la acción (CARGAR/DESCARGAR)
    {% if accion == "CARGAR" %}
        G1 E50 F300
        G1 E50 F300
        G1 E50 F300
        G1 E50 F300
    {% elif accion == "DESCARGAR" %}
        G1 E-5 F100
        G1 E-50 F300
        G1 E-50 F300
        G1 E-50 F300
        G1 E-50 F300
    {% else %}
        RESPOND PREFIX="ERROR" MSG="Acción no válida. Debe ser CARGAR o DESCARGAR."
        CANCEL_PRINT
    {% endif %}

    G90  ; Volver a modo absoluto

    # Restaurar temperatura original
    {% if prev_temp == 0 %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    {% else %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={prev_temp}
    {% endif %}


[gcode_macro CARGAR_FILAMENTO]
description: Cargar filamento (usa la macro FILAMENTO)
gcode:
    {% set material = params.MATERIAL|default("PLA") %}
    FILAMENTO MATERIAL={material} ACCION=CARGAR

[gcode_macro DESCARGAR_FILAMENTO]
description: Descargar filamento (usa la macro FILAMENTO)
gcode:
    {% set material = params.MATERIAL|default("PLA") %}
    FILAMENTO MATERIAL={material} ACCION=DESCARGAR
